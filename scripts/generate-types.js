/* This file is a part of @mdn/browser-compat-data
 * See LICENSE file for more information. */

/* c8 ignore start */

import fs from 'node:fs/promises';
import { fileURLToPath } from 'node:url';

import esMain from 'es-main';
import { compileFromFile } from 'json-schema-to-typescript';

import { spawn } from '../utils/index.js';

const root = new URL('..', import.meta.url);

const opts = {
  bannerComment:
    '/* This file is a part of @mdn/browser-compat-data\n * See LICENSE file for more information. */\n\n/**\n* This file was automatically generated by json-schema-to-typescript.\n* DO NOT MODIFY IT BY HAND. Instead, modify the source schema files in\n* schemas/*, and run "npm run gentypes" to regenerate this file.\n*/',
  unreachableDefinitions: true,
};

/**
 * Transform the TypeScript to remove unneeded bits of typedefs
 * @param {string} ts Typedefs
 * @returns {string} Updated typedefs
 */
const transformTS = (ts) => {
  // Remove "interface was referenced" comments.
  ts = ts
    .replace(
      /( \*\n)? \* This interface was referenced by [^\n]+\n \* via the [^\n]+\n/g,
      '',
    )
    .replace(/\/\*\*\n \*\/\n/g, '');

  return ts;
};

/**
 * Compile the TypeScript typedefs from the schema JSON
 * @param {string} source - JSON schema source
 * @param {URL | string} destination - Output destination
 */
const compile = async (source, destination) => {
  let ts = await compileFromFile(source, opts);

  ts = transformTS(ts);

  const file =
    destination instanceof URL ? destination : new URL(destination, root);

  await fs.writeFile(file, ts);
  spawn('tsc', ['--skipLibCheck', fileURLToPath(file)], {
    cwd: fileURLToPath(root),
    stdio: 'inherit',
  });
};

if (esMain(import.meta)) {
  await Promise.all([
    compile('schemas/browsers.schema.json', 'types/browsers.d.ts'),
    compile('schemas/compat-data.schema.json', 'types/compat-data.d.ts'),
    compile('schemas/public.schema.json', 'types/types.d.ts'),
  ]);
}

export default compile;

/* c8 ignore stop */
